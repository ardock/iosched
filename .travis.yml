# Copyright 2014 Google Inc. All rights reserved.
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

language: android

# jdk:
  # Check Travis JDKs http://docs.travis-ci.com/user/languages/java/#Testing-Against-Multiple-JDKs
  # Test against one or more JDKs: 'jdk' is combined with 'env' to construct a build matrix.
  # - openjdk7
  # - oraclejdk7

android:
  components:
    # Check the project requirements and the components included by default on Travis-ci vm image.
    # Check required: https://github.com/google/iosched/blob/master/doc/BUILDING.md
    # Check defaults: http://docs.travis-ci.com/user/languages/android/#Pre-installed-components

    # Check Android SDK Platform-tools: http://developer.android.com/tools/revisions/platforms.html
    # Check Android SDK tools: http://developer.android.com/tools/sdk/tools-notes.html
    # Comment the lines below if the latest revisions of Android SDK Tools are included by default.
    # - platform-tools
    - tools

    # Check BuildTools: http://developer.android.com/tools/revisions/build-tools.html
    # Comment the lines below if the latest BuildTools revisions required for building are included.
    # - build-tools-20.0.0
    - build-tools-21.0.2

    # Comment the lines below if the SDK versions used to compile android are already included.
    # - android-20
    - android-21

    # Comment the lines below if the latest additional components are included or not required.
    # - extra-google-google_play_services
    - extra-google-m2repository
    - extra-android-m2repository
    # - extra-android-support

    # Comment the lines below if the latest images are included or you don't need to run emulator/s.
    # - sys-img-armeabi-v7a-android-wear-20
    - sys-img-armeabi-v7a-android-21

  licenses:
    # Check licenses: http://docs.travis-ci.com/user/languages/android/#Dealing-with-Licenses
    # By default Travis will accept all the licenses, but it's also possible to define a white list:
    # White list android-sdk-license used by Android SDK Platform-tools, rev 21 and other tools.
    - 'android-sdk-license-5be876d5'
    # White list all android-sdk-license revisions.
    # - 'android-sdk-license-.+'
    # White list all the licenses.
    # - '.+'

notifications:
  email: false

env:
  matrix:
    # Travis CI will run your tests against a matrix of all possible combinations (including 'jdk').
    # For Android projects, env and jdk can be given as arrays to construct a build matrix.
    # See http://docs.travis-ci.com/user/build-configuration/#The-Build-Matrix
    - ANDROID_TARGET=android-15  ANDROID_ABI=armeabi-v7a ARGS=''
    - ANDROID_TARGET=android-16  ANDROID_ABI=armeabi-v7a ARGS=''
    - ANDROID_TARGET=android-17  ANDROID_ABI=armeabi-v7a ARGS=''
    - ANDROID_TARGET=android-18  ANDROID_ABI=armeabi-v7a ARGS=''
    - ANDROID_TARGET=android-19  ANDROID_ABI=armeabi-v7a ARGS=''
    - ANDROID_TARGET=android-21  ANDROID_ABI=armeabi-v7a ARGS=''
    # - ANDROID_TARGET=android-15  ANDROID_ABI=armeabi-v7a ARGS='-PdisablePreDex'
    # - ANDROID_TARGET=android-16  ANDROID_ABI=armeabi-v7a ARGS='-PdisablePreDex'
    # - ANDROID_TARGET=android-17  ANDROID_ABI=armeabi-v7a ARGS='-PdisablePreDex'
    # - ANDROID_TARGET=android-18  ANDROID_ABI=armeabi-v7a ARGS='-PdisablePreDex'
    # - ANDROID_TARGET=android-19  ANDROID_ABI=armeabi-v7a ARGS='-PdisablePreDex'
    # - ANDROID_TARGET=android-21  ANDROID_ABI=armeabi-v7a ARGS='-PdisablePreDex'

before_install:
  # - echo " @-- EXTRA DEPENDENCIES --@ "
  # Check Travis build lifecycle http://docs.travis-ci.com/user/build-configuration/#Build-Lifecycle
  # Travis CI uses virtual machine snapshotting to make sure no state is left between builds.
  # Check http://docs.travis-ci.com/user/customizing-the-build/#Customizing-the-Installation-Step
  # Use this to prepare the system to install prerequisites or dependencies e.g. sudo apt-get update
  - pwd && ls -al && sudo apt-get update -qq

  # - echo " @-- CREATE & START EMULATOR --@ "
  # Comment out the line below to add +x permissions to wait for emulator script.
  - chmod +x scripts/wait_for_emulator.sh
  # Comment out the line below to add Disable pre-dexing option to build matrix and gradle commands.
  # - if [[ "${ARGS:-}" == *-PdisablePreDex* ]]; then export DISABLE_PREDEX="-PdisablePreDex"; fi
  # Comment out the line below to custom avd name. Defaults to test if not used (:- ads default '').
  # - export AVD_NAME="test-${ANDROID_TARGET}-${ANDROID_ABI}-${RANDOM:-}${DISABLE_PREDEX:-}"
  # Create and start emulator. If custom AVD_NAME is not found, defaults to 'test' name.
  - echo no | android create avd --force -n "${AVD_NAME:-test}" -t "$ANDROID_TARGET" --abi "$ANDROID_ABI"
  - emulator -avd "${AVD_NAME:-test}" -no-skin -no-audio -no-window &

  # - echo " @-- GRADLE ANDROID DEPENDENCIES --@ "
  # Check Build with Gradle: http://developer.android.com/sdk/installing/studio-build.html
  # Comment out the lines below to add execution permission to gradle on Travis VM linux machine.
  - chmod +x gradlew
  # Comment out the lines below to show android SDK components installed and android dependencies.
  # Travis downloads gradle first time is called and we download dependencies before avs start up.
  - android list sdk --no-ui --all --extended | grep -E '^id:' | awk -F '"' '{$1=""; print $2}'
  # - TERM=dumb ./gradlew androidDependencies

# install:
  # Check install section: http://docs.travis-ci.com/user/build-configuration/#install
  # If you'd like to skip the install stage entirely, set it to true and nothing will be run.
  # - true


before_script:
  # - echo " @-- WAIT FOR EMULATOR --@ "
  - ./scripts/wait_for_emulator.sh
  - adb shell input keyevent 82 &

# script:
  # - echo " @-- CLEAN PROJECT --@ "
  # Comment out the line below to clean and prepare the Debug and DebugTest project sources.
  # - TERM=dumb ./gradlew clean generateDebugSources generateDebugTestSources

  # Added disable pre-dexing option to build matrix. Code checks if ARGS contains '-PdisablePreDex'
  # and if  ${DISABLE_PREDEX:-} option is added on ./gradlew, disables pre-dexing on build server.
  # Otherwise pre-dexing enabled. It's the default option if ARGS or DISABLE_PREDEX not found.
  # http://tools.android.com/tech-docs/new-build-system/tips#TOC-Improving-Build-Server-performance.
  # - TERM=dumb ./gradlew assembleDebug ${DISABLE_PREDEX:-}
  # - TERM=dumb ./gradlew assembleDebugTest ${DISABLE_PREDEX:-}

  # Installs and runs tests fro Build 'debug' on connected devices
  # Remember add DISABLE_PREDEX flag always your gradle tasks perform predex to avoid dexing errors.
  # - TERM=dumb ./gradlew connectedAndroidTest ${DISABLE_PREDEX:-}

  # - echo " @-- DEBUG TEST FINISHED, NOW RELEASE TEST --@ "

  # Comment out the line below to prepare the Release project sources (predex wearable, be aware).
  # - TERM=dumb ./gradlew generateReleaseSources ${DISABLE_PREDEX:-}

  # Assembles and tests this project
  # - TERM=dumb ./gradlew assembleRelease  ${DISABLE_PREDEX:-}

  # Comment out the line below to run all device checks on currently connected devices
  # - TERM=dumb ./gradlew connectedCheck ${DISABLE_PREDEX:-}

  # - echo " @-- RELEASE TEST FINISHED --@ "

after_failure:
  # Customize this line, 'android' is the specific app module name of this project. Shows log.
  - export MY_MOD="android"
  - export MY_LOG_DIR="$(pwd)/${MY_MOD}/build/outputs/reports/androidTests/connected/"
  - pwd && cd "${MY_LOG_DIR:-.}" && pwd && ls -al
  - sudo apt-get install -qq lynx && lynx --dump index.html > myIndex.log
  - lynx --dump com.android.builder.testing.ConnectedDevice.html > myConnectedDevice.log
  - lynx --dump com.android.builder.testing.html > myTesting.log
  - for file in *.log; do echo "$file"; echo "====================="; cat "$file"; done || true
  # TODO: Solve issue (timeout api-21) https://code.google.com/p/android/issues/detail?id=69735
  # UPDATE: Solution coming soon :) https://android-review.googlesource.com/#/c/112780/
  # TODO: Offer known solutions after failure.


after_success:
  - echo " @-- Success --@ "
  # - echo " @-- @-- @-- Lollipops For All --@ --@ --@ "

# after_script:
  # Check http://docs.travis-ci.com/user/build-configuration/#Build-Lifecycle
  # Test result is exported to TRAVIS_TEST_RESULT which you can use in commands run in after_script.
  # Standard Unix exit code of "0" means the build passed; everything else is treated as failure.
  # - echo "TRAVIS_TEST_RESULT ${TRAVIS_TEST_RESULT}"
  # - if [[ "${TRAVIS_TEST_RESULT}" == "0" ]] ; then echo "BUILD SUCCESSFUL" ; else echo "ERROR" ; fi

  # @--@--@--@--@
  # @-- ERROR --@
  # @--@--@--@--@
  # @-- 132.1 --@
  # Error occurred while compiling the build script: undefined method `empty?' for nil:NilClass
  # @-- android-21 (android: components:)
  #
  # @-- 134.1 --@
  # Could not find any version that matches com.google.android.gms:play-services-wearable:6.1.+.
  # @-- extra-google-m2repository (android: components:)
  #
  # @-- 135.5 --@
  # Error Code: 127 com.android.ide.common.internal.LoggedErrorException :android:preDexDebug
  # @--
  #
  # @-- 135.6 --@
  # 135.6 Invalid --abi armeabi-v7a for the selected target. (android-21)
  # @--
  #
  # @-- 137.1 --@
  # Manifest merger failed : uses-sdk:minSdkVersion 14 cannot be smaller than version L declared ...
  # @-- extra-android-m2repository (android: components:)

  # @-- 141.5 --@
  # The command "./gradlew build connectedCheck" exited with 137.
  # @-- Reload job, killed by Travis-ci, not an error, your build is slow or is a temporal issue.
  #
  # @-- 142.1 --@
  # Failed to find Build Tools revision 21.0.2
  # @-- build-tools-21.0.2 (android: components:)
  #
  #
  #
  # @-- TODO: --@
  # Failed to Initialize backend EGL display.
  # emulator: WARNING: Could not initialize OpenglES emulation, using software renderer.
  # @-- https://groups.google.com/forum/#!msg/adt-dev/gwcLeOTfxD4/kW-qebk0C-wJ  useful?
  #
  # @-- TODO: --@
  # Modules without test, gradle 0.13.2, connectedAndroidTest will fail ?
  # @-- https://code.google.com/p/android/issues/detail?id=76249